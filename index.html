<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Animation Budgeting Advisor</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      padding: 20px;
      color: #333;
    }
    h1 1.2rem;
      margin-bottom: 15px;
      color: #1a1a1a;
    }
    #status {
      margin-bottom: 15px;
      font-size: 0.9rem;
      color: #666;
    }
    #status .dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 6px;
      vertical-align: middle;
    }
    .dot-idle { background: #aaa; }
    .dot-connecting { background: #FFC107; }
    .dot-connected { background: #4CAF50; }
    .dot-ended { background: #f44336; }
    #controls {
      margin-bottom: 20px;
    }
    button {
      padding: 10px 24px;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      cursor: pointer;
      transition: background 0.2s;
      margin-right: 10px;
    }
    #downloadPdf {
      background: #2196F3;
      color: white;
      display: none;
    }
    #downloadPdf:hover { background: #1E88E5; }
    #transcript-box {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 15px;
      min-height: 100px;
    }
    #transcript-box p {
      margin-bottom: 10px;
      line-height: 1.6;
      padding: 6px 10px;
      border-radius: 6px;
    }
    .role-ai {
      color: #1565C0;
      background: #E3F2FD;
    }
    .role-user {
      color: #2E7D32;
      background: #E8F5E9;
    }
    #transcript-box .empty {
      color: #aaa;
      font-style: italic;
      background: none;
    }
  </style>
</head>
<body>
  <h1>ðŸŽ¬ Animation Budgeting Advisor</h1>

  <div id="status">
    <span class="dot dot-idle"></span> Click the phone icon in the bottom-right to start
  </div>

  <div id="controls">
    <button id="downloadPdf" onclick="downloadPDF()">ðŸ“¥ Download Transcript (PDF)</button>
  </div>

  <div id="transcript-box">
    <p class="empty">Transcript will appear here once the call starts...</p>
  </div>

  <script src="https://cdn.jsdelivr.net/gh/VapiAI/html-script-tag@latest/dist/assets/index.js" defer async></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    var transcriptLines = [];

    const VAPI_PUBLIC_KEY = 'fe7a575d-3cdd-4242-8f65-c24e6f1a89d3'; // <-- Replace with your pk- key
    const ASSISTANT_ID = '65412f7d-5d9b-408d-87f7-bbafc3674082';

    function setStatus(text, dotClass) {
      document.getElementById('status').innerHTML =
        '<span class="dot ' + dotClass + '"></span> ' + text;
    }

    window.addEventListener('load', function() {
      var checkSDK = setInterval(function() {
        if (window.vapiSDK) {
          clearInterval(checkSDK);
          initVapi();
        }
      }, 500);
    });

    function initVapi() {
      var vapi = window.vapiSDK.run({
        apiKey: VAPI_PUBLIC_KEY,
        assistant: ASSISTANT_ID,
        config: {
          position: 'bottom-right'
        }
      });

      vapi.on('call-start', function() {
        setStatus('Connected â€” speak now', 'dot-connected');
        document.getElementById('downloadPdf').style.display = 'none';
        document.getElementById('transcript-box').innerHTML = '';
        transcriptLines = [];
      });

      vapi.on('message', function(msg) {
        if (msg.type === 'transcript' && msg.transcriptType === 'final') {
          var role = msg.role === 'assistant' ? 'Advisor' : 'You';
          var cls = msg.role === 'assistant' ? 'role-ai' : 'role-user';
          transcriptLines.push({ role: role, text: msg.transcript });
          var box = document.getElementById('transcript-box');
          var p = document.createElement('p');
          p.className = cls;
          p.innerHTML = '<strong>' + role + ':</strong> ' + msg.transcript;
          box.appendChild(p);
          box.scrollTop = box.scrollHeight;
        }
      });

      vapi.on('call-end', function() {
        setStatus('Call ended â€” download your transcript below', 'dot-ended');
        document.getElementById('downloadPdf').style.display = 'inline-block';
      });

      vapi.on('error', function(e) {
        console.error('Vapi error:', e);
      });
    }

    function downloadPDF() {
      var jsPDF = window.jspdf.jsPDF;
      var doc = new jsPDF();
      var pageWidth = doc.internal.pageSize.getWidth();
      var margin = 20;
      var maxWidth = pageWidth - margin * 2;
      var y = 20;

      doc.setFontSize(18);
      doc.setTextColor(26, 26, 26);
      doc.text('Animation Budgeting Advisor', margin, y);
      y += 8;

      doc.setFontSize(10);
      doc.setTextColor(100, 100, 100);
      doc.text('Call Date: ' + new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString(), margin, y);
      y += 5;

      doc.setDrawColor(200, 200, 200);
      doc.line(margin, y, pageWidth - margin, y);
      y += 10;

      doc.setFontSize(11);
      transcriptLines.forEach(function(line) {
        if (line.role === 'Advisor') {
          doc.setTextColor(21, 101, 192);
        } else {
          doc.setTextColor(46, 125, 50);
        }
        doc.setFont(undefined, 'bold');
        var roleText = line.role + ':';
        doc.text(roleText, margin, y);

        doc.setFont(undefined, 'normal');
        doc.setTextColor(51, 51, 51);
        var textLines = doc.splitTextToSize(line.text, maxWidth - 5);
        var roleWidth = doc.getTextWidth(roleText + ' ');

        if (roleWidth + doc.getTextWidth(textLines[0]) < maxWidth) {
          doc.text(textLines[0], margin + roleWidth, y);
          y += 6;
          for (var i = 1; i < textLines.length; i++) {
            if (y > 275) { doc.addPage(); y = 20; }
            doc.text(textLines[i], margin, y);
            y += 6;
          }
        } else {
          y += 6;
          textLines.forEach(function(tl) {
            if (y > 275) { doc.addPage(); y = 20; }
            doc.text(tl, margin, y);
            y += 6;
          });
        }
        y += 4;

        if (y > 275) { doc.addPage(); y = 20; }
      });

      y += 5;
      doc.setDrawColor(200, 200, 200);
      doc.line(margin, y, pageWidth - margin, y);
      y += 8;
      doc.setFontSize(9);
      doc.setTextColor(150, 150, 150);
      doc.text('Generated by Animation Budgeting Advisor', margin, y);

      doc.save('call-transcript-' + new Date().toISOString().slice(0, 10) + '.pdf');
    }
  </script>
</body>
</html>
